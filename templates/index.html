<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éƒ¨æ´»æ¨è–¦AI</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .ai-response { white-space: pre-wrap; background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .ban-message { color: red; font-weight: bold; margin-top: 15px; }
        #question-form { display: flex; margin-top: 20px; }
        #question-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #question-form button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; }
        
        #loading-message {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none; 
        }
        
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #question-form[disabled] input, #question-form[disabled] button {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <h1>æ—©ç¨²ç”°ä¸­å­¦ éƒ¨æ´»æ¨è–¦AIï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</h1>
    
    <div class="ai-response">
        {{ response }}
    </div>

    <div id="loading-message">
        AIãŒè€ƒãˆä¸­... å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ ğŸ¤–
    </div>

    <form id="question-form" method="POST" action="/" onsubmit="return checkBanAndSetCookie(event)">
        <input type="text" name="question" id="question-input" placeholder="éƒ¨æ´»ã®èˆˆå‘³ã‚’è³ªå•ã—ã¦ãã ã•ã„..." required>
        <button type="submit" id="submit-button">è³ªå•ã™ã‚‹</button>
    </form>

    <script>
        const BAN_DURATION_MS = 24 * 60 * 60 * 1000;
        const MAX_SAME_QUESTION_COUNT = 3; 
        const STORAGE_KEY = 'question_history';
        const form = document.getElementById('question-form');
        const input = document.getElementById('question-input');
        const button = document.getElementById('submit-button');

        function checkBanAndSetCookie(event) {
            event.preventDefault(); 
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼šäºŒé‡é€ä¿¡é˜²æ­¢ãƒã‚§ãƒƒã‚¯
            if (button.disabled) {
                console.log("Client side block: Already disabled.");
                return false;
            }

            const currentTime = Date.now();
            const userQuestion = input.value.trim(); 

            if (!userQuestion) {
                // ğŸš¨ ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆã¯ã€å…¥åŠ›ãŒç©ºã¾ãŸã¯ç©ºç™½ã®ã¿
                console.log("Input is empty or only whitespace. Stopping submission.");
                return false;
            }
            
            // --- 1. å±¥æ­´ã®ãƒ­ãƒ¼ãƒ‰ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ---
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            
            for (const key in history) {
                if (currentTime - history[key].first_time >= BAN_DURATION_MS) {
                    delete history[key];
                }
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

            // --- 2. BANï¼ˆåˆ¶é™ï¼‰ãƒã‚§ãƒƒã‚¯ ---
            const questionRecord = history[userQuestion];
            let currentCount = 0;
            let firstTime = currentTime;

            if (questionRecord) {
                currentCount = questionRecord.count;
                firstTime = questionRecord.first_time;
            }

            if (currentCount >= MAX_SAME_QUESTION_COUNT) {
                // åˆ¶é™å›æ•°ã‚’è¶…éã—ãŸå ´åˆã®å‡¦ç†ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰
                const timeElapsed = currentTime - firstTime;
                const remainingTimeMs = BAN_DURATION_MS - timeElapsed;
                const remainingHours = Math.floor(remainingTimeMs / (1000 * 60 * 60));
                const remainingMinutes = Math.ceil((remainingTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeMessage = (remainingHours > 0 ? `${remainingHours} æ™‚é–“` : '') + ` ${remainingMinutes} åˆ†`;

                const banDiv = document.createElement('div');
                banDiv.className = 'ban-message';
                banDiv.innerHTML = `**ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™**ï¼šã‚·ã‚¹ãƒ†ãƒ ä¿è­·ã®ãŸã‚ã€åŒã˜è³ªå•ã®å†é€ä¿¡å›æ•°ï¼ˆ${MAX_SAME_QUESTION_COUNT}å›ï¼‰ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚èª ã«æã‚Œå…¥ã‚Šã¾ã™ãŒã€**æ®‹ã‚Šç´„ ${timeMessage}** ãŒçµŒéã™ã‚‹ã‹ã€**è³ªå•ã®å†…å®¹ã‚’å¤‰æ›´**ã—ã¦ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚**ã”æ³¨æ„ï¼šã“ã®åˆ¶é™ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®LocalStorageã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚**`;
                
                const responseDiv = document.querySelector('.ai-response');
                const existingBan = document.querySelector('.ban-message');
                if (existingBan) {
                    existingBan.remove();
                }
                responseDiv.parentNode.insertBefore(banDiv, responseDiv.nextElementSibling);
                
                return false; 
            }
            
            // --- 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ãƒ•ã‚©ãƒ¼ãƒ ç„¡åŠ¹åŒ– (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´äºŒé‡é€ä¿¡é˜²æ­¢) ---
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            input.disabled = true;
            button.disabled = true;
            form.setAttribute('disabled', 'disabled'); // ã‚¹ã‚¿ã‚¤ãƒ«ç”¨
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById('loading-message').style.display = 'block';

            // --- 4. å±¥æ­´ã®æ›´æ–° ---
            history[userQuestion] = {
                count: currentCount + 1,
                first_time: firstTime === currentTime ? currentTime : firstTime
            };

            // LocalStorageã«ä¿å­˜
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

            // --- 5. ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ ---
            form.submit();
        }
        
        // ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã€ã¾ãŸã¯å¿œç­”ãŒè¿”ã£ã¦ããŸã¨ãã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ (å¿µã®ãŸã‚)
        window.onload = function() {
            input.disabled = false;
            button.disabled = false;
            form.removeAttribute('disabled');
            document.getElementById('loading-message').style.display = 'none';
        }
    </script>

</body>
</html>
