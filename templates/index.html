<script>
    console.log("--- JS DEBUG: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ ---");
    
    const form = document.getElementById('question-form');
    const input = document.getElementById('question-input');
    const button = document.getElementById('submit-button');

    // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†ã‚’å®šç¾© (submit ã‚¤ãƒ™ãƒ³ãƒˆ)
    async function handleSubmit(event) {
        event.preventDefault(); // æ¨™æº–ã® submit å‹•ä½œã‚’å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯
        console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ (submitãƒªã‚¹ãƒŠãƒ¼çµŒç”±) ---");
        
        if (button.disabled) {
            console.log("--- JS DEBUG: ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ ---");
            return;
        }

        const userQuestion = input.value.trim(); 

        if (!userQuestion) {
            console.log("--- JS DEBUG: å…¥åŠ›å€¤ãŒç©ºã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ ---");
            alert("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        console.log("--- JS DEBUG: å…¥åŠ›ãƒã‚§ãƒƒã‚¯é€šéã€‚Fetch APIã§é€ä¿¡é–‹å§‹ ---");
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ç„¡åŠ¹åŒ–
        document.getElementById('loading-message').style.display = 'block';
        input.disabled = true;
        button.disabled = true;
        form.setAttribute('disabled', 'disabled');

        const formData = new FormData();
        formData.append('question', userQuestion);
        
        try {
            const response = await fetch('/', {
                method: 'POST',
                body: formData 
            });

            // æˆåŠŸã‹ã¤ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒè¡Œã‚ã‚ŒãŸã‹ã‚’ç¢ºèª
            if (response.ok) {
                // ğŸš¨ ã“ã“ãŒé‡è¦ï¼šFetchã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•è¿½å¾“ã—ãªã„ãŸã‚ã€æ‰‹å‹•ã§ã‚¸ãƒ£ãƒ³ãƒ—ã•ã›ã‚‹
                if (response.redirected) {
                    console.log("--- JS DEBUG: Fetch æˆåŠŸã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ¤œçŸ¥ã€‚æ‰‹å‹•ã§ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ ---");
                    window.location.href = response.url; // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®URLã«é·ç§»ã•ã›ã‚‹
                } else {
                    console.log("--- JS DEBUG: Fetch æˆåŠŸã€‚ã—ã‹ã—ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãªã—ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦GETå‡¦ç†ã‚’å¼·åˆ¶ã—ã¾ã™ ---");
                    window.location.reload(); 
                }
            } else {
                console.error("--- JS DEBUG: Fetch å¤±æ•— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: " + response.status + ") ---");
                alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                
                // å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–ã«æˆ»ã™
                input.disabled = false;
                button.disabled = false;
                form.removeAttribute('disabled');
                document.getElementById('loading-message').style.display = 'none';
            }

        } catch (error) {
            console.error("--- JS DEBUG: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ ---", error);
            alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');

            // å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–ã«æˆ»ã™
            input.disabled = false;
            button.disabled = false;
            form.removeAttribute('disabled');
            document.getElementById('loading-message').style.display = 'none';
        }

        console.log("--- JS DEBUG: Fetch å®Ÿè¡Œå®Œäº† ---");
    }
    
    window.onload = function() {
        console.log("--- JS DEBUG: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº† ---");
        
        if (form) {
            form.addEventListener('submit', handleSubmit);
            console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ ã« 'submit' ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ ---");
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã®æœ‰åŠ¹åŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
        if (input) input.disabled = false;
        if (button) button.disabled = false;
        if (form) form.removeAttribute('disabled');
        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) loadingMessage.style.display = 'none';
    }
    
    window.checkBanAndSetCookie = handleSubmit;
</script>
