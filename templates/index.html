<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éƒ¨æ´»æ¨è–¦AI</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .ai-response { white-space: pre-wrap; background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .ban-message { color: red; font-weight: bold; margin-top: 15px; }
        #question-form { display: flex; margin-top: 20px; }
        #question-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #question-form button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; }
        
        #loading-message {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none; 
        }
        
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #question-form[disabled] input, #question-form[disabled] button {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <h1>æ—©ç¨²ç”°ä¸­å­¦ éƒ¨æ´»æ¨è–¦AIï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</h1>
    
    <div class="ai-response">
        {{ response }}
    </div>

    <div id="loading-message">
        AIãŒè€ƒãˆä¸­... å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ ğŸ¤–
    </div>

    <form id="question-form" method="POST" action="/" novalidate>
        <input type="text" name="question" id="question-input" placeholder="éƒ¨æ´»ã®èˆˆå‘³ã‚’è³ªå•ã—ã¦ãã ã•ã„...">
        <button type="submit" id="submit-button">è³ªå•ã™ã‚‹</button> 
    </form>

    <script>
        console.log("--- JS DEBUG: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ ---");
        
        const FORM_COOLDOWN_SECONDS = 5;
        const LAST_SUBMIT_TIME_KEY = 'LAST_SUBMIT_TIME';
        
        const form = document.getElementById('question-form');
        const input = document.getElementById('question-input');
        const button = document.getElementById('submit-button');
        const responseDiv = document.querySelector('.ai-response'); // å¿œç­”è¡¨ç¤ºã‚¨ãƒªã‚¢

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å…±é€šé–¢æ•°
        function restoreFormState(errorMessage = null) {
            input.disabled = false;
            button.disabled = false;
            form.removeAttribute('disabled');
            document.getElementById('loading-message').style.display = 'none';

            if (errorMessage) {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¨ãƒ©ãƒ¼ (ãƒãƒ³æ©Ÿèƒ½ã€å…¥åŠ›ãƒã‚§ãƒƒã‚¯ãªã©)
                responseDiv.textContent = errorMessage;
                responseDiv.style.color = 'red'; 
                responseDiv.style.backgroundColor = '#ffeeee';
            }
        }


        // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†ã‚’å®šç¾© (submit ã‚¤ãƒ™ãƒ³ãƒˆ)
        async function handleSubmit(event) {
            event.preventDefault(); 
            console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ ---");
            
            if (button.disabled) {
                console.log("--- JS DEBUG: ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ ---");
                return;
            }

            const userQuestion = input.value.trim(); 
            if (!userQuestion) {
                restoreFormState("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            // ğŸš¨ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒãƒ³æ©Ÿèƒ½ã®ãƒã‚§ãƒƒã‚¯
            const lastTimeStr = localStorage.getItem(LAST_SUBMIT_TIME_KEY);
            const lastTime = lastTimeStr ? parseFloat(lastTimeStr) : 0;
            const currentTime = Date.now(); // ãƒŸãƒªç§’
            
            if (lastTime && (currentTime - lastTime) < (FORM_COOLDOWN_SECONDS * 1000)) {
                const remaining = FORM_COOLDOWN_SECONDS - Math.ceil((currentTime - lastTime) / 1000);
                restoreFormState(`äºŒé‡é€ä¿¡ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ã®ä¿è­·ã®ãŸã‚ã€ã‚ã¨ç´„ ${remaining} ç§’å¾…ã£ã¦ã‹ã‚‰å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚`);
                return; // ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦é€ä¿¡ã—ãªã„
            }

            console.log("--- JS DEBUG: å…¥åŠ›ãƒã‚§ãƒƒã‚¯ãƒ»ãƒãƒ³ãƒã‚§ãƒƒã‚¯é€šéã€‚Fetch APIã§é€ä¿¡é–‹å§‹ ---");
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ç„¡åŠ¹åŒ–
            document.getElementById('loading-message').style.display = 'block';
            input.disabled = true;
            button.disabled = true;
            form.setAttribute('disabled', 'disabled');

            const formData = new FormData();
            formData.append('question', userQuestion);
            
            try {
                // ğŸš¨ é€ä¿¡æ™‚åˆ»ã‚’ localStorage ã«ä¿å­˜ (æˆåŠŸ/å¤±æ•—ã«ã‹ã‹ã‚ã‚‰ãšã€ã¾ãšã“ã“ã§è¨˜éŒ²)
                localStorage.setItem(LAST_SUBMIT_TIME_KEY, currentTime.toString());
                
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData 
                });
                
                // JSONå¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹
                const data = await response.json(); 

                if (data.success) {
                    console.log("--- JS DEBUG: Fetch æˆåŠŸã€ç”»é¢ã‚’AIå¿œç­”ã§æ›¸ãæ›ãˆ ---");
                    responseDiv.textContent = data.response; 
                    responseDiv.style.color = 'initial';
                    responseDiv.style.backgroundColor = '#f0f0f0';
                } else {
                    console.error("--- JS DEBUG: Fetch å¤±æ•— (ã‚µãƒ¼ãƒãƒ¼å´ã‚¨ãƒ©ãƒ¼) ---");
                    // ã‚µãƒ¼ãƒãƒ¼å´ã‚¨ãƒ©ãƒ¼ (APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ãªã©) ã¯èµ¤æ–‡å­—è¡¨ç¤º
                    restoreFormState(data.message || "ã‚µãƒ¼ãƒãƒ¼å´ã§äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    return; 
                }
                
                form.reset();
                restoreFormState();

            } catch (error) {
                console.error("--- JS DEBUG: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ ---", error);
                restoreFormState("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯å¿œç­”ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }

            console.log("--- JS DEBUG: Fetch å®Ÿè¡Œå®Œäº† ---");
        }
        
        window.onload = function() {
            console.log("--- JS DEBUG: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº† ---");
            
            if (form) {
                form.addEventListener('submit', handleSubmit);
                console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ ã« 'submit' ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ ---");
            }
            
            // åˆæœŸçŠ¶æ…‹ã‚’æœ‰åŠ¹åŒ–
            restoreFormState();
        }
    </script>

</body>
</html>
