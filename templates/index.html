<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>éƒ¨æ´»æ¨è–¦AI</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .ai-response { white-space: pre-wrap; background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .ban-message { color: red; font-weight: bold; margin-top: 15px; }
        #question-form { display: flex; margin-top: 20px; }
        #question-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #question-form button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; }
        
        #loading-message {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none; 
        }
        
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #question-form[disabled] input, #question-form[disabled] button {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <h1>æ—©ç¨²ç”°ä¸­å­¦ éƒ¨æ´»æ¨è–¦AIï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</h1>
    
    <div class="ai-response">
        {{ response }}
    </div>

    <div id="loading-message">
        AIãŒè€ƒãˆä¸­... å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ ğŸ¤–
    </div>

    <form id="question-form" method="POST" action="/" novalidate>
        <input type="text" name="question" id="question-input" placeholder="éƒ¨æ´»ã®èˆˆå‘³ã‚’è³ªå•ã—ã¦ãã ã•ã„...">
        <button type="submit" id="submit-button">è³ªå•ã™ã‚‹</button> 
    </form>

    <script>
        console.log("--- JS DEBUG: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ ---");
        
        const form = document.getElementById('question-form');
        const input = document.getElementById('question-input');
        const button = document.getElementById('submit-button');

        // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†ã‚’å®šç¾© (submit ã‚¤ãƒ™ãƒ³ãƒˆ)
        async function handleSubmit(event) {
            event.preventDefault(); 
            console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ (submitãƒªã‚¹ãƒŠãƒ¼çµŒç”±) ---");
            
            if (button.disabled) {
                console.log("--- JS DEBUG: ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ ---");
                return;
            }

            const userQuestion = input.value.trim(); 

            if (!userQuestion) {
                console.log("--- JS DEBUG: å…¥åŠ›å€¤ãŒç©ºã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ ---");
                alert("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            console.log("--- JS DEBUG: å…¥åŠ›ãƒã‚§ãƒƒã‚¯é€šéã€‚Fetch APIã§é€ä¿¡é–‹å§‹ ---");
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ç„¡åŠ¹åŒ–
            document.getElementById('loading-message').style.display = 'block';
            input.disabled = true;
            button.disabled = true;
            form.setAttribute('disabled', 'disabled');

            const formData = new FormData();
            formData.append('question', userQuestion);
            
            try {
                // Fetch APIã« redirect: 'follow' ã‚’è¿½åŠ ã€‚ãŸã ã—æœ€çµ‚ç¢ºèªã¯æ‰‹å‹•ã§è¡Œã†
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData,
                    redirect: 'manual' // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•è¿½å¾“ã—ãªã„è¨­å®š
                });

                // ã‚µãƒ¼ãƒãƒ¼ãŒ302ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿”ã—ã¦ã„ã‚‹ã‹ç¢ºèª
                if (response.status === 302 || response.redirected) {
                    // ã‚µãƒ¼ãƒãƒ¼ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿”ã—ãŸå ´åˆã€æ‰‹å‹•ã§ãã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆï¼ˆ/ï¼‰ã«ã‚¸ãƒ£ãƒ³ãƒ—
                    const locationHeader = response.headers.get('Location');
                    if (locationHeader) {
                        console.log("--- JS DEBUG: Fetch æˆåŠŸã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ¤œçŸ¥ã€‚æ‰‹å‹•ã§ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ ---");
                        window.location.href = locationHeader; 
                        return; // æˆåŠŸã—ãŸå ´åˆã¯ã“ã“ã§çµ‚äº†
                    }
                }
                
                // ãã‚Œä»¥å¤–ã®æˆåŠŸ (200 OK ãªã©) ã‚„ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„å ´åˆ
                if (response.ok) {
                    console.log("--- JS DEBUG: Fetch æˆåŠŸã€‚æ„å›³ã—ãªã„æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‚ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§å¼·åˆ¶åŒæœŸã—ã¾ã™ ---");
                    window.location.reload(); 
                    return;
                } else {
                    console.error("--- JS DEBUG: Fetch å¤±æ•— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: " + response.status + ") ---");
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

            } catch (error) {
                console.error("--- JS DEBUG: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ ---", error);
                alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
            
            // å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–ã«æˆ»ã™
            input.disabled = false;
            button.disabled = false;
            form.removeAttribute('disabled');
            document.getElementById('loading-message').style.display = 'none';

            console.log("--- JS DEBUG: Fetch å®Ÿè¡Œå®Œäº† ---");
        }
        
        window.onload = function() {
            console.log("--- JS DEBUG: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº† ---");
            
            if (form) {
                form.addEventListener('submit', handleSubmit);
                console.log("--- JS DEBUG: ãƒ•ã‚©ãƒ¼ãƒ ã« 'submit' ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ ---");
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®æœ‰åŠ¹åŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (input) input.disabled = false;
            if (button) button.disabled = false;
            if (form) form.removeAttribute('disabled');
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) loadingMessage.style.display = 'none';
        }
        
        window.checkBanAndSetCookie = handleSubmit;
    </script>

</body>
</html>
